name: Telegram Notification

on:
  workflow_call:
    inputs:
      workflow_name:
        required: true
        type: string
      status:
        required: true
        type: string
        description: 'success, failure, or cancelled'
      workflow_url:
        required: true
        type: string
      commit_message:
        required: false
        type: string
        default: ''
      commit_author:
        required: false
        type: string
        default: ''
      image_tags:
        required: false
        type: string
        default: ''
        description: 'Comma-separated list of image tags'
      image_url:
        required: false
        type: string
        default: ''
        description: 'Full image URL/path'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        run: |
          # Check if secrets are configured
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi
          
          STATUS_EMOJI=""
          if [ "${{ inputs.status }}" == "success" ]; then
            STATUS_EMOJI="‚úÖ"
          elif [ "${{ inputs.status }}" == "failure" ]; then
            STATUS_EMOJI="‚ùå"
          else
            STATUS_EMOJI="‚ö†Ô∏è"
          fi
          
          COMMIT_INFO=""
          if [ -n "${{ inputs.commit_message }}" ]; then
            COMMIT_INFO="\nüìù Commit: ${{ inputs.commit_message }}"
            if [ -n "${{ inputs.commit_author }}" ]; then
              COMMIT_INFO="$COMMIT_INFO\nüë§ Author: ${{ inputs.commit_author }}"
            fi
          fi
          
          IMAGE_INFO=""
          if [ -n "${{ inputs.image_url }}" ] && [ "${{ inputs.status }}" == "success" ]; then
            IMAGE_INFO="\n\nüê≥ *Docker Image Available*"
            if [ -n "${{ inputs.image_tags }}" ]; then
              # Convert comma-separated tags to newline-separated list
              TAGS=$(echo "${{ inputs.image_tags }}" | tr ',' '\n' | sed 's/^/  ‚Ä¢ /')
              IMAGE_INFO="$IMAGE_INFO\nüì¶ Tags:\n$TAGS"
            fi
            IMAGE_INFO="$IMAGE_INFO\n\n\`docker pull ${{ inputs.image_url }}\`"
          fi
          
          MESSAGE="${STATUS_EMOJI} *${{ inputs.workflow_name }}* - ${{ inputs.status }}$COMMIT_INFO$IMAGE_INFO
          
          üîó [View Workflow](${{ inputs.workflow_url }})"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=false

